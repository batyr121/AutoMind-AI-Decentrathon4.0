<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöó CarInspector - AI –ê–Ω–∞–ª–∏–∑ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª—è</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* (—Ç–æ—Ç –∂–µ CSS, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –ø—Ä–∏—Å–ª–∞–ª ‚Äî —è –Ω–µ –º–µ–Ω—è–ª –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; color:#333; }
        .container { max-width:1000px; margin:0 auto; background:white; border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden; }
        .header{ background: linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%); color:white; padding:40px; text-align:center; }
        .header h1{ font-size:2.5em; margin-bottom:10px; font-weight:700; }
        .header p{ font-size:1.2em; opacity:0.9; font-weight:300; }
        .main-content{ padding:40px; }
        .upload-section{ text-align:center; margin-bottom:40px; }
        .upload-area{ border:3px dashed #d1d5db; border-radius:15px; padding:60px 40px; background:#f8fafc; cursor:pointer; transition:all .3s; margin:30px 0; }
        .upload-area:hover{ border-color:#4f46e5; background:#eff6ff; transform:translateY(-2px); }
        .upload-area.dragover{ border-color:#4f46e5; background:#dbeafe; transform:scale(1.02); }
        .upload-icon{ font-size:3em; color:#4f46e5; margin-bottom:20px; }
        .upload-text{ font-size:1.2em; color:#6b7280; margin-bottom:20px; }
        .btn{ background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%); color:white; padding:15px 30px; border:none; border-radius:10px; font-size:1.1em; font-weight:600; cursor:pointer; transition:all .3s; display:inline-flex; align-items:center; gap:10px; }
        .btn:hover{ transform:translateY(-2px); box-shadow:0 10px 20px rgba(79,70,229,0.3); }
        .preview-section{ text-align:center; margin:30px 0; }
        #preview{ max-width:100%; max-height:400px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.1); display:none; }
        .loading{ text-align:center; padding:40px; display:none; }
        .spinner{ width:50px; height:50px; border:4px solid #e5e7eb; border-top:4px solid #4f46e5; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px; }
        @keyframes spin{ 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        .result-section{ display:none; animation:fadeIn .5s ease; }
        @keyframes fadeIn{ from{ opacity:0; transform:translateY(20px);} to{ opacity:1; transform:translateY(0); } }
        .result-card{ background:white; border-radius:15px; padding:30px; box-shadow:0 10px 25px rgba(0,0,0,0.1); margin:20px 0; }
        .result-header{ display:flex; align-items:center; gap:15px; margin-bottom:20px; }
        .result-icon{ font-size:2em; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; }
        .damage .result-icon{ background:#fef2f2; color:#ef4444; }
        .no-damage .result-icon{ background:#f0fdf4; color:#10b981; }
        .result-title{ font-size:1.5em; font-weight:600; }
        .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin:30px 0; }
        .stat-card{ background:#f8fafc; padding:20px; border-radius:12px; text-align:center; }
        .stat-number{ font-size:2em; font-weight:700; color:#4f46e5; margin-bottom:5px; }
        .stat-label{ color:#6b7280; font-weight:500; }
        .damage-list{ margin:30px 0; }
        .damage-item{ background:white; padding:20px; border-radius:12px; border-left:4px solid #f59e0b; box-shadow:0 4px 12px rgba(0,0,0,0.05); margin:15px 0; }
        .progress-bar{ height:12px; background:#e5e7eb; border-radius:6px; margin:10px 0; overflow:hidden; }
        .progress{ height:100%; background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%); border-radius:6px; transition:width .5s ease; }
        .history-section{ margin-top:40px; padding:30px; background:#f8fafc; border-radius:15px; }
        .history-title{ font-size:1.3em; font-weight:600; margin-bottom:20px; color:#374151; }
        .history-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; }
        .history-item{ background:white; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05); cursor:pointer; transition:all .3s ease; }
        .history-item:hover{ transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,0.1); }
        .footer{ text-align:center; padding:30px; background:#f8fafc; color:#6b7280; border-top:1px solid #e5e7eb; }
        @media (max-width:768px){ .header{ padding:30px 20px; } .header h1{ font-size:2em; } .main-content{ padding:20px; } .upload-area{ padding:40px 20px; } .stats-grid{ grid-template-columns:1fr; } .history-grid{ grid-template-columns:1fr; } }
        .pulse{ animation:pulse 2s infinite; }
        @keyframes pulse{ 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
        .fade-in{ animation:fadeIn .6s ease; }
        .btn-secondary{ background:white; color:#4f46e5; border:2px solid #4f46e5; }
        .btn-secondary:hover{ background:#4f46e5; color:white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-car-crash"></i> CarInspector</h1>
            <p>AI-—Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª—è</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h2>
                <p class="upload-text">–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –Ω–∞–ª–∏—á–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π</p>
                
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p class="upload-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞ –∏–ª–∏</p>
                    <button class="btn" onclick="document.getElementById('file-input').click()">
                        <i class="fas fa-camera"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª
                    </button>
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                </div>
            </div>

            <div class="preview-section">
                <img id="preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é AI...</p>
                <p style="color: #6b7280; margin-top: 10px;">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</p>
            </div>

            <div class="result-section" id="result-section">
                <div class="result-card" id="result-card">
                    <div class="result-header">
                        <div class="result-icon" id="result-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h2 class="result-title" id="result-title">–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω</h2>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="stat-confidence">0%</div>
                            <div class="stat-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stat-damages">0</div>
                            <div class="stat-label">–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stat-severity">-</div>
                            <div class="stat-label">–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å</div>
                        </div>
                    </div>

                    <div id="damage-list" class="damage-list"></div>
                    <div id="probabilities"></div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" onclick="analyzeNew()">
                            <i class="fas fa-redo"></i> –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
                        </button>
                        <button class="btn btn-secondary" onclick="shareResults()" style="margin-left: 10px;">
                            <i class="fas fa-share"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                        </button>
                    </div>
                </div>
            </div>

            <div class="history-section">
                <h3 class="history-title"><i class="fas fa-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>
                <div class="history-grid" id="history-grid">
                    <div class="history-item">
                        <p style="text-align: center; color: #6b7280;">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>¬© 2024 CarInspector | AI Powered Car Damage Detection</p>
            <p style="margin-top: 10px; font-size: 0.9em;">
                <i class="fas fa-brain"></i> Powered by Deep Learning |
                <i class="fas fa-shield-alt"></i> 100% –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ
            </p>
        </div>
    </div>

    <script>
    // ======= JS: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–≤–æ–∏–º Flask (–ø–æ—Ä—Ç 5500) –∏ —Ñ–æ—Ä–º–∞—Ç–æ–º –æ—Ç–≤–µ—Ç–∞ =======
    const API_URL = "http://127.0.0.1:5500/api/analyze"; // —è–≤–Ω–æ –Ω–∞ Flask-–ø–æ—Ä—Ç 5500

    // RU-–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –¥–ª—è —á–∞—Å—Ç–µ–π (17 –∫–ª–∞—Å—Å–æ–≤ –∏–∑ —Ç–≤–æ–µ–π YOLO)
    const PARTS_RU = {
        back_bumper: "–ó–∞–¥–Ω–∏–π –±–∞–º–ø–µ—Ä",
        back_glass: "–ó–∞–¥–Ω–µ–µ —Å—Ç–µ–∫–ª–æ",
        back_left_door: "–ó–∞–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å",
        back_left_light: "–ó–∞–¥–Ω–∏–π –ª–µ–≤—ã–π —Ñ–æ–Ω–∞—Ä—å",
        back_right_door: "–ó–∞–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å",
        back_right_light: "–ó–∞–¥–Ω–∏–π –ø—Ä–∞–≤—ã–π —Ñ–æ–Ω–∞—Ä—å",
        front_bumper: "–ü–µ—Ä–µ–¥–Ω–∏–π –±–∞–º–ø–µ—Ä",
        front_glass: "–õ–æ–±–æ–≤–æ–µ —Å—Ç–µ–∫–ª–æ",
        front_left_door: "–ü–µ—Ä–µ–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å",
        front_left_light: "–ü–µ—Ä–µ–¥–Ω–∏–π –ª–µ–≤—ã–π —Ñ–æ–Ω–∞—Ä—å",
        front_right_door: "–ü–µ—Ä–µ–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å",
        front_right_light: "–ü–µ—Ä–µ–¥–Ω–∏–π –ø—Ä–∞–≤—ã–π —Ñ–æ–Ω–∞—Ä—å",
        hood: "–ö–∞–ø–æ—Ç",
        left_mirror: "–õ–µ–≤–æ–µ –∑–µ—Ä–∫–∞–ª–æ",
        right_mirror: "–ü—Ä–∞–≤–æ–µ –∑–µ—Ä–∫–∞–ª–æ",
        tailgate: "–ü—è—Ç–∞—è –¥–≤–µ—Ä—å / –±–∞–≥–∞–∂–Ω–∏–∫",
        wheel: "–ö–æ–ª–µ—Å–æ"
    };

    const DAMAGE_RU = { none: "–ù–µ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è", dent: "–í–º—è—Ç–∏–Ω–∞", rust: "–†–∂–∞–≤—á–∏–Ω–∞", scratch: "–¶–∞—Ä–∞–ø–∏–Ω–∞" };
    const CLEAN_RU = { clean: "–ß–∏—Å—Ç–∞—è", dirty: "–ì—Ä—è–∑–Ω–∞—è" };

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const preview = document.getElementById('preview');
    const loading = document.getElementById('loading');
    const resultSection = document.getElementById('result-section');
    const resultCard = document.getElementById('result-card');
    const resultIcon = document.getElementById('result-icon');
    const resultTitle = document.getElementById('result-title');
    const historyGrid = document.getElementById('history-grid');

    let currentAnalysis = null;

    // Drag and Drop
    ['dragenter','dragover','dragleave','drop'].forEach(evt => uploadArea.addEventListener(evt, preventDefaults, false));
    function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }
    ['dragenter','dragover'].forEach(evt => uploadArea.addEventListener(evt, ()=>uploadArea.classList.add('dragover')));
    ['dragleave','drop'].forEach(evt => uploadArea.addEventListener(evt, ()=>uploadArea.classList.remove('dragover')));
    uploadArea.addEventListener('drop', e => { const dt = e.dataTransfer; if(dt.files.length) handleFiles(dt.files[0]); }, false);
    fileInput.addEventListener('change', function(){ if(this.files.length) handleFiles(this.files[0]); });

    function handleFiles(file){
        const reader = new FileReader();
        reader.onload = function(e){
            preview.src = e.target.result;
            preview.style.display = 'block';
            uploadArea.style.display = 'none';
            uploadFile(file);
        }
        reader.readAsDataURL(file);
    }

    function uploadFile(file){
        const formData = new FormData();
        // –í–ê–ñ–ù–û: backend –∂–¥—ë—Ç –∫–ª—é—á "image"
        formData.append('image', file);

        loading.style.display = 'block';
        resultSection.style.display = 'none';

        fetch(API_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                loading.style.display = 'none';
                // –æ–∂–∏–¥–∞–µ–º data.parts ‚Äî –º–∞—Å—Å–∏–≤ –¥–µ—Ç–µ–∫—Ü–∏–π
                showResultFromParts(data);
                addToHistory(data);
            })
            .catch(err => {
                loading.style.display = 'none';
                showError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: " + (err.message || err));
            });
    }

    function showResultFromParts(data){
        if(data.error) return showError(data.error);
        const parts = Array.isArray(data.parts) ? data.parts : [];
        currentAnalysis = data;

        // –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        // overall confidence = max damage confidence across parts
        let overall_conf = 0;
        let has_damage = false;
        let damage_types = []; // {type, type_ru, confidence, part}
        let cleanliness_votes = {clean: 0, dirty: 0};
        let cleanliness_conf_sum = {clean: 0, dirty: 0};

        parts.forEach(p => {
            // p.damage: {label, confidence}
            // p.dirty: {label, confidence}
            if(p.damage && p.damage.label){
                if(p.damage.label !== 'none' && p.damage.confidence > 0){
                    has_damage = true;
                    damage_types.push({
                        type: p.damage.label,
                        type_ru: DAMAGE_RU[p.damage.label] || p.damage.label,
                        confidence: p.damage.confidence,
                        part: p.part || ""
                    });
                }
                overall_conf = Math.max(overall_conf, (p.damage.confidence || 0));
            }
            if(p.dirty && p.dirty.label){
                cleanliness_votes[p.dirty.label] = (cleanliness_votes[p.dirty.label] || 0) + 1;
                cleanliness_conf_sum[p.dirty.label] = (cleanliness_conf_sum[p.dirty.label] || 0) + (p.dirty.confidence || 0);
            }
        });

        // –≤—ã–≤–æ–¥–∏–º –æ–±—â—É—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (–∫–∞–∫ –ø—Ä–æ—Ü–µ–Ω—Ç)
        const confidence = overall_conf;

        // –û–ø—Ä–µ–¥–µ–ª–∏–º –æ–±—â—É—é "–≥—Ä—è–∑–Ω–æ—Å—Ç—å": –±–µ—Ä—ë–º —Ç–æ—Ç –∫–ª–∞—Å—Å, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã—à–µ —Å—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏–ª–∏ –±–æ–ª—å—à–µ –≥–æ–ª–æ—Å–æ–≤
        let cleanliness = null;
        const cleanCount = cleanliness_votes.clean || 0;
        const dirtyCount = cleanliness_votes.dirty || 0;
        const cleanAvg = cleanCount ? (cleanliness_conf_sum.clean / cleanCount) : 0;
        const dirtyAvg = dirtyCount ? (cleanliness_conf_sum.dirty / dirtyCount) : 0;

        if(cleanCount === 0 && dirtyCount === 0){
            // –µ—Å–ª–∏ –Ω–µ—Ç –¥–µ—Ç–µ–∫—Ü–∏–π / –Ω–µ—Ç –æ—Ü–µ–Ω–∫–∏ —á–∏—Å—Ç–æ—Ç—ã
            cleanliness = null;
        } else {
            // –ø—Ä–∏ –ø—Ä–æ—á–∏—Ö —Ä–∞–≤–Ω—ã—Ö –±–µ—Ä—ë–º —Å—Ä–µ–¥–Ω—é—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
            if(dirtyAvg > cleanAvg) {
                cleanliness = { label: 'dirty', label_ru: CLEAN_RU['dirty'], confidence: dirtyAvg };
            } else {
                cleanliness = { label: 'clean', label_ru: CLEAN_RU['clean'], confidence: cleanAvg };
            }
        }

        // –°—Ñ–æ—Ä–º–∏—Ä—É–µ–º 'predictions' –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ: –¥–ª—è dent, rust, scratch –≤–æ–∑—å–º—ë–º –º–∞–∫—Å–∏–º—É–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ —á–∞—Å—Ç—è–º
        const predictions = { dent: 0, rust: 0, scratch: 0, car: 1.0 };
        damage_types.forEach(d => {
            if(predictions[d.type] === undefined) predictions[d.type] = d.confidence;
            else predictions[d.type] = Math.max(predictions[d.type], d.confidence);
        });

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º damage_types –ø–æ —É–±—ã–≤–∞–Ω–∏—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
        damage_types.sort((a,b) => b.confidence - a.confidence);

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI
        document.getElementById('stat-confidence').textContent = `${Math.round(confidence * 100)}%`;
        document.getElementById('stat-damages').textContent = damage_types.length;
        document.getElementById('stat-severity').textContent = has_damage ? '–ï—Å—Ç—å' : '–ù–µ—Ç';

        // –∫–∞—Ä—Ç–æ—á–∫–∞
        if(has_damage){
            resultCard.className = 'result-card damage';
            resultIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            resultTitle.innerHTML = '‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è!';
        } else {
            resultCard.className = 'result-card no-damage';
            resultIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            resultTitle.innerHTML = '‚úÖ –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ';
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º damage-list
        const damageList = document.getElementById('damage-list');
        damageList.innerHTML = '';

        // YOLO-–¥–µ—Ç–µ–∫—Ü–∏–∏ (–ø–µ—Ä–µ—á–µ–Ω—å —á–∞—Å—Ç–µ–π)
        if(parts.length > 0){
            damageList.innerHTML += '<h3 style="margin:10px 0;color:#374151;">üöò –ù–∞–π–¥–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—à–∏–Ω—ã:</h3>';
            parts.forEach(p => {
                const partRu = PARTS_RU[p.part] || p.part || '–ß–∞—Å—Ç—å';
                const yconf = (p.yolo_confidence || 0);
                damageList.innerHTML += `
                    <div class="damage-item">
                        <h4>${partRu}</h4>
                        <p>YOLO: ${(yconf*100).toFixed(1)}%</p>
                        <p>–ß–∏—Å—Ç–æ—Ç–∞: ${p.dirty ? (CLEAN_RU[p.dirty.label] || p.dirty.label) + ' (' + (p.dirty.confidence*100).toFixed(1) + '%)' : '‚Äî'}</p>
                        <p>–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ: ${p.damage ? (DAMAGE_RU[p.damage.label] || p.damage.label) + ' (' + (p.damage.confidence*100).toFixed(1) + '%)' : '‚Äî'}</p>
                    </div>
                `;
            });
        } else {
            damageList.innerHTML += '<div class="damage-item"><p style="color:#6b7280;">–î–µ—Ç–µ–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
        }

        // –û–±—â–∞—è —á–∏—Å—Ç–æ—Ç–∞
        if(cleanliness){
            damageList.innerHTML += `
                <div class="damage-item">
                    <h4>üßΩ –ß–∏—Å—Ç–æ—Ç–∞ –º–∞—à–∏–Ω—ã</h4>
                    <p>${cleanliness.label_ru} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ${(cleanliness.confidence*100).toFixed(1)}%)</p>
                </div>
            `;
        }

        // –û–±—â–∏–µ —Ç–∏–ø—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
        if(damage_types.length > 0){
            damageList.innerHTML += '<h3 style="margin:10px 0;color:#374151;">üî® –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è:</h3>';
            damage_types.forEach(d => {
                const percent = (d.confidence * 100).toFixed(1);
                damageList.innerHTML += `
                    <div class="damage-item">
                        <h4>${d.type_ru} ‚Äî ${PARTS_RU[d.part] || d.part || ''}</h4>
                        <p>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${percent}%</p>
                        <div class="progress-bar"><div class="progress" style="width:${percent}%"></div></div>
                    </div>
                `;
            });
        }

        // –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è)
        const probabilities = document.getElementById('probabilities');
        probabilities.innerHTML = '<h3 style="margin-bottom:20px;color:#374151;">üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>';
        for(const [cls, prob] of Object.entries(predictions)){
            const percent = (prob * 100).toFixed(1);
            const clsRu = cls === 'car' ? '–ê–≤—Ç–æ–º–æ–±–∏–ª—å' : (cls === 'dent' ? '–í–º—è—Ç–∏–Ω–∞' : (cls === 'rust' ? '–†–∂–∞–≤—á–∏–Ω–∞' : (cls === 'scratch' ? '–¶–∞—Ä–∞–ø–∏–Ω–∞' : cls)));
            probabilities.innerHTML += `
                <div style="margin:15px 0;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                        <span style="font-weight:500;">${clsRu}:</span>
                        <span style="color:#4f46e5;font-weight:600;">${percent}%</span>
                    </div>
                    <div class="progress-bar"><div class="progress" style="width:${percent}%"></div></div>
                </div>
            `;
        }

        // –∑–∞–ø–æ–º–Ω–∏–º –≤ currentAnalysis —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, —á—Ç–æ–±—ã share/history —Ä–∞–±–æ—Ç–∞–ª–∏
        currentAnalysis = {
            has_damage: has_damage,
            confidence: confidence,
            damage_types: damage_types,
            cleanliness: cleanliness,
            parts: parts,
            predictions: predictions,
            message: has_damage ? "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è" : "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        };

        resultSection.style.display = 'block';
        resultSection.scrollIntoView({ behavior: 'smooth' });
    }

    function showError(message){
        resultCard.className = 'result-card damage';
        resultIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
        resultTitle.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
        document.getElementById('damage-list').innerHTML = `<div style="text-align:center;padding:20px;color:#ef4444;"><p>${message}</p><button class="btn" onclick="analyzeNew()" style="margin-top:20px;"><i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button></div>`;
        resultSection.style.display = 'block';
    }

    function analyzeNew(){
        uploadArea.style.display = 'block';
        preview.style.display = 'none';
        resultSection.style.display = 'none';
        fileInput.value = '';
        preview.src = '';
    }

    function shareResults(){
        if(currentAnalysis){
            const text = `–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞: ${currentAnalysis.message}\n–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(currentAnalysis.confidence*100).toFixed(1)}%`;
            if(navigator.share){
                navigator.share({ title:'CarInspector - –†–µ–∑—É–ª—å—Ç–∞—Ç', text:text, url:window.location.href }).catch(console.error);
            } else {
                alert(text);
            }
        }
    }

    function addToHistory(data){
        const historyItem = { id: Date.now(), timestamp:new Date().toLocaleString(), result: currentAnalysis || data };
        let history = JSON.parse(localStorage.getItem('carInspectorHistory') || '[]');
        history.unshift(historyItem);
        history = history.slice(0,6);
        localStorage.setItem('carInspectorHistory', JSON.stringify(history));
        updateHistoryDisplay();
    }

    function updateHistoryDisplay(){
        const history = JSON.parse(localStorage.getItem('carInspectorHistory') || '[]');
        if(history.length === 0){
            historyGrid.innerHTML = `<div class="history-item"><p style="text-align:center;color:#6b7280;">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫</p></div>`;
            return;
        }
        historyGrid.innerHTML = '';
        history.forEach(item => {
            const hasDamage = item.result && item.result.has_damage;
            historyGrid.innerHTML += `
                <div class="history-item" onclick="loadHistoryItem(${item.id})">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                        <div style="width:12px;height:12px;border-radius:50%;background:${hasDamage ? '#ef4444' : '#10b981'};"></div>
                        <span style="font-weight:500;color:${hasDamage ? '#ef4444' : '#10b981'};">${hasDamage ? '–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è' : '–ë–µ–∑ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π'}</span>
                    </div>
                    <p style="color:#6b7280;font-size:0.9em;">${item.timestamp}</p>
                </div>
            `;
        });
    }

    function loadHistoryItem(id){
        const history = JSON.parse(localStorage.getItem('carInspectorHistory') || '[]');
        const item = history.find(i => i.id === id);
        if(item) {
            // –æ—Ç–æ–±—Ä–∞–∑–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
            currentAnalysis = item.result;
            // —Ä—É—á–Ω–æ–π –≤—ã–∑–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –ø–æ–¥—Å—Ç—Ä–æ–∏–º –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç currentAnalysis
            // –µ—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç —Ç–µ—Ö –ø–æ–ª–µ–π, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
            document.getElementById('stat-confidence').textContent = `${Math.round((currentAnalysis.confidence||0)*100)}%`;
            document.getElementById('stat-damages').textContent = (currentAnalysis.damage_types||[]).length || 0;
            document.getElementById('stat-severity').textContent = currentAnalysis.has_damage ? '–ï—Å—Ç—å' : '–ù–µ—Ç';
            // –ø–æ–∫–∞–∂–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            document.getElementById('damage-list').innerHTML = `<div class="damage-item"><p style="color:#6b7280;">–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏</p></div>`;
            document.getElementById('probabilities').innerHTML = '';
            resultSection.style.display = 'block';
        }
    }

    document.addEventListener('DOMContentLoaded', updateHistoryDisplay);
    </script>
</body>
</html>
